<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cbt.track.dao.TabTrackInfoMapping">

    <select id="queryByTrackNo" parameterType="java.lang.String" resultType="com.cbt.bean.TabTrackInfo">
        SELECT
			of.user_id id, sp.orderid orderNo, sp.remarks orderList, sp.transportcompany trackCompany, sp.expressno trackNo,
		    ti.track_state trackState, of.orderpaytime orderPaytime, ti.order_deliverDate orderDeliverDate, 
		    ti.updat_date updatDate, ti.track_update trackUpdate, ti.delivered_time deliveredTime, ti.source_type sourceType,
		    sp.createtime senttime,tf.track_no_forward forwardNo,tf.track_company_forward forwardCompany,
		    tf.source_type forwardSourceType
		FROM
			(
				SELECT
					*
				FROM
					shipping_package
				WHERE
					expressno = #{trackNo}
			) sp
		LEFT JOIN orderinfo of ON sp.orderid = of.order_no
		LEFT JOIN cross_border_shop.tab_track_info ti 
			ON sp.transportcompany = ti.track_company AND sp.expressno = ti.track_no
		<!-- LEFT JOIN shipment st ON sp.expressno = st.orderNo -->
		LEFT JOIN (
			SELECT track_no,GROUP_CONCAT(track_no_forward) track_no_forward,
			GROUP_CONCAT(track_company_forward) track_company_forward,
			GROUP_CONCAT(source_type) source_type
			FROM cross_border_shop.tab_track_forward WHERE track_no = #{trackNo}
			AND track_company = 
				(SELECT transportcompany FROM shipping_package WHERE expressno = #{trackNo} LIMIT 1)
 			GROUP BY track_no
		) tf
			ON sp.expressno = tf.track_no
		LIMIT 1
    </select>

	<select id="getWarningRecordList" resultType="com.cbt.bean.TabTrackInfo">
        SELECT
            au.admName, of.user_id id, sp.orderid orderNo, sp.remarks orderList, sp.transportcompany trackCompany, sp.expressno trackNo,
		    ti.track_state trackState, of.orderpaytime orderPaytime, ti.order_deliverDate orderDeliverDate, ti.updat_date updatDate, 
		    ti.track_update trackUpdate, ti.delivered_time deliveredTime, ti.source_type sourceType,
		    sp.createtime senttime,tf.track_no_forward forwardNo,tf.track_company_forward forwardCompany
		FROM
			(
				SELECT
					*
				FROM
					shipping_package
				WHERE
					sflag = 3
			) sp
		INNER JOIN orderinfo of ON sp.orderid = of.order_no
		LEFT JOIN cross_border_shop.tab_track_info ti 
			ON sp.transportcompany = ti.track_company AND sp.expressno = ti.track_no
        <!-- LEFT JOIN shipment st ON sp.expressno = st.orderNo -->
        LEFT JOIN cross_border_shop.tab_track_forward tf
			ON sp.expressno = tf.track_no AND sp.transportcompany = tf.track_company
        LEFT JOIN admin_r_user ar ON of.user_id = ar.userid
        LEFT JOIN admuser au ON au.id = ar.adminid
        WHERE 1=1
        <if test="userid != null">
            AND ar.adminid = #{userid}
        </if>
        <if test="warning == 0">
            AND ((ti.track_state != 3 AND ti.track_state != 7 AND datediff(NOW(), sp.createtime) >= 3 AND 
            ((datediff(ti.updat_date,ti.track_update) IS null
            OR datediff(ti.updat_date,ti.track_update) > 3
            OR now() > ti.order_deliverDate))
            OR ti.track_state IN (4,5,6)))
        </if>
        <if test="warning == 1"> /*0-查询所有异常运单；1-物流问题；2-交期超时；5-异常(海关扣押等)；6-内部异常（抓取方式没有，单号问题等）*/
             AND ti.track_state != 3 AND ti.track_state != 7 
             AND datediff(NOW(), sp.createtime) >= 3
             AND (datediff(ti.updat_date,ti.track_update) IS null OR datediff(ti.updat_date,ti.track_update) > 3)
        </if>
        <if test="warning == 2">
             AND ti.track_state != 3 AND ti.track_state != 7 
             AND now() > ti.order_deliverDate
        </if>
        <if test="warning == 4">
            AND ti.track_state = 4
        </if>
        <if test="warning == 5">
            AND ti.track_state = 5
        </if>
        <if test="warning == 6">
            AND ti.track_state = 6
        </if>
        <if test="startDate != ''">
            AND (of.orderpaytime >= #{startDate} OR of.orderpaytime IS NULL)
        </if>
        <if test="endDate != ''">
            AND (#{endDate} >= of.orderpaytime OR of.orderpaytime IS NULL)
        </if>
        ORDER BY
			sp.createtime ASC,
			of.order_no
        LIMIT #{startBars},#{rows}
    </select>

    <select id="getRecordListByTrackState" resultType="com.cbt.bean.TabTrackInfo">
        SELECT
            au.admName,of.user_id id, sp.orderid orderNo, sp.remarks orderList, sp.transportcompany trackCompany, sp.expressno trackNo,
		    ti.track_state trackState, of.orderpaytime orderPaytime, ti.order_deliverDate orderDeliverDate, 
		    ti.updat_date updatDate, ti.track_update trackUpdate, ti.delivered_time deliveredTime, ti.source_type sourceType,
		    sp.createtime senttime,tf.track_no_forward forwardNo,tf.track_company_forward forwardCompany
		FROM
			(
				SELECT
					*
				FROM
					shipping_package
				WHERE
					sflag = 3
			) sp
		INNER JOIN orderinfo of ON sp.orderid = of.order_no
		LEFT JOIN cross_border_shop.tab_track_info ti 
			ON sp.transportcompany = ti.track_company AND sp.expressno = ti.track_no
		LEFT JOIN cross_border_shop.tab_track_forward tf
			ON sp.expressno = tf.track_no AND sp.transportcompany = tf.track_company
        LEFT JOIN admin_r_user ar ON of.user_id = ar.userid
        LEFT JOIN admuser au ON au.id = ar.adminid
        <!-- LEFT JOIN shipment st ON sp.expressno = st.orderNo -->
        WHERE 1=1
        <if test="userid != null">
            AND ar.adminid = #{userid}
        </if>
        <if test="trackState != 0 and trackState != 7">
            AND ti.track_state = #{trackState} /*1-备货中；2-已发货；3-已签收；4-退回；5-异常(海关扣押等)；6-内部异常（抓取方式没有，单号问题等）; 7-手动标记正常*/
        </if>
        <if test="trackState == 7">
            AND ti.track_note IS NOT NULL AND ti.track_note != "" 
        </if>
        <if test="startDate != ''">
            AND (of.orderpaytime >= #{startDate} OR of.orderpaytime IS NULL)
        </if>
        <if test="endDate != ''">
            AND (#{endDate} >= of.orderpaytime OR of.orderpaytime IS NULL)
        </if>
        ORDER BY
			sp.createtime ASC,
			of.order_no
        LIMIT #{startBars},#{rows}
    </select>

    <select id="getRecordListByOrderOrTrackNo" resultType="com.cbt.bean.TabTrackInfo">
        SELECT
            au.admName, of.user_id id, sp.orderid orderNo, sp.remarks orderList, sp.transportcompany trackCompany, sp.expressno trackNo,
		    ti.track_state trackState, of.orderpaytime orderPaytime, ti.order_deliverDate orderDeliverDate, 
		    ti.updat_date updatDate, ti.track_update trackUpdate, ti.delivered_time deliveredTime, ti.source_type sourceType,
		    sp.createtime senttime,tf.track_no_forward forwardNo,tf.track_company_forward forwardCompany
		FROM
			(
				SELECT
					*
				FROM
					shipping_package
				WHERE
					remarks LIKE #{orderNo} OR expressno LIKE #{trackNo}
			) sp
		LEFT JOIN orderinfo of ON sp.orderid = of.order_no
		LEFT JOIN cross_border_shop.tab_track_info ti 
			ON sp.transportcompany = ti.track_company AND sp.expressno = ti.track_no
		<!-- LEFT JOIN shipment st ON sp.expressno = st.orderNo -->
		LEFT JOIN cross_border_shop.tab_track_forward tf
			ON sp.expressno = tf.track_no AND sp.transportcompany = tf.track_company
		LEFT JOIN admin_r_user ar ON of.user_id = ar.userid
        LEFT JOIN admuser au ON au.id = ar.adminid
        <where>
            <if test="userid != null">
                ar.adminid = #{userid}
            </if>
            <if test="startDate != ''">
                AND (of.orderpaytime >= #{startDate} OR of.orderpaytime IS NULL)
            </if>
            <if test="endDate != ''">
                AND (#{endDate} >= of.orderpaytime OR of.orderpaytime IS NULL)
            </if>
        </where>
		ORDER BY
			sp.createtime ASC,
			of.order_no
    </select>

    <!--List<TabTrackInfo> getRecordListByUserid(@Param("orderUserid") String orderUserid, @Param("userid") Integer userid);-->
    <select id="getRecordListByUserid" resultType="com.cbt.bean.TabTrackInfo">
        SELECT
            au.admName, of.user_id id, sp.orderid orderNo, sp.remarks orderList, sp.transportcompany trackCompany, sp.expressno trackNo,
		    ti.track_state trackState, of.orderpaytime orderPaytime, ti.order_deliverDate orderDeliverDate,
		    ti.updat_date updatDate, ti.track_update trackUpdate, ti.delivered_time deliveredTime, ti.source_type sourceType,
		    sp.createtime senttime,tf.track_no_forward forwardNo,tf.track_company_forward forwardCompany
		FROM
			(
				SELECT
					*
				FROM
					shipping_package
			) sp
		LEFT JOIN orderinfo of ON sp.orderid = of.order_no
		LEFT JOIN cross_border_shop.tab_track_info ti
			ON sp.transportcompany = ti.track_company AND sp.expressno = ti.track_no
		LEFT JOIN cross_border_shop.tab_track_forward tf
			ON sp.expressno = tf.track_no AND sp.transportcompany = tf.track_company
		LEFT JOIN admin_r_user ar ON of.user_id = ar.userid
        LEFT JOIN admuser au ON au.id = ar.adminid
        LEFT JOIN user u ON u.id = of.user_id
        <where>
            <if test="userid != null">
                ar.adminid = #{userid}
            </if>
            <if test="orderUserid != null">
                AND (of.user_id = #{orderUserid} OR u.email LIKE '%${orderUserid}%')
            </if>
            <if test="startDate != ''">
                AND (of.orderpaytime >= #{startDate} OR of.orderpaytime IS NULL)
            </if>
            <if test="endDate != ''">
                AND (#{endDate} >= of.orderpaytime OR of.orderpaytime IS NULL)
            </if>
        </where>
		ORDER BY
			sp.createtime ASC,
			of.order_no
    </select>

    <!-- List<TabTrackInfo> getForwardListByTrackNo(@Param("trackNo") String trackNo); -->
	<select id="getForwardListByTrackNo" resultType="com.cbt.bean.TabTrackInfo">
        SELECT
			au.admName, of.user_id id, sp.orderid orderNo, sp.remarks orderList, sp.transportcompany trackCompany, sp.expressno trackNo,
		    ti.track_state trackState, of.orderpaytime orderPaytime, ti.order_deliverDate orderDeliverDate, 
		    ti.updat_date updatDate, ti.track_update trackUpdate, ti.delivered_time deliveredTime, ti.source_type sourceType,
		    sp.createtime senttime,tf.track_no_forward forwardNo,tf.track_company_forward forwardCompany
		FROM
			(
				SELECT * FROM cross_border_shop.tab_track_forward WHERE track_no_forward LIKE #{trackNo}
			) tf
		LEFT JOIN shipping_package sp
			ON sp.expressno = tf.track_no AND sp.transportcompany = tf.track_company
		LEFT JOIN orderinfo of ON sp.orderid = of.order_no
		LEFT JOIN cross_border_shop.tab_track_info ti 
			ON sp.transportcompany = ti.track_company AND sp.expressno = ti.track_no
		LEFT JOIN admin_r_user ar ON of.user_id = ar.userid
        LEFT JOIN admuser au ON au.id = ar.adminid
        <where>
            <if test="userid != null">
                ar.adminid = #{userid}
            </if>
            <if test="startDate != ''">
                AND (of.orderpaytime >= #{startDate} OR of.orderpaytime IS NULL)
            </if>
            <if test="endDate != ''">
                AND (#{endDate} >= of.orderpaytime OR of.orderpaytime IS NULL)
            </if>
        </where>
		ORDER BY
			sp.createtime ASC,
			of.order_no
    </select>
    
    <select id="getWarningRecordCount" resultType="java.lang.Integer">
        SELECT
			COUNT(1)
		FROM
			(
				SELECT
					*
				FROM
					shipping_package
				WHERE
					sflag = 3
			) sp
		INNER JOIN orderinfo of ON sp.orderid = of.order_no
		LEFT JOIN cross_border_shop.tab_track_info ti 
			ON sp.transportcompany = ti.track_company AND sp.expressno = ti.track_no
        LEFT JOIN cross_border_shop.tab_track_forward tf
            ON sp.expressno = tf.track_no AND sp.transportcompany = tf.track_company
        LEFT JOIN admin_r_user ar ON of.user_id = ar.userid
        LEFT JOIN admuser au ON au.id = ar.adminid
        WHERE 1=1
        <if test="userid != null">
            AND ar.adminid = #{userid}
        </if>
        <if test="warning == 0">
            AND ((ti.track_state != 3 AND ti.track_state != 7 AND datediff(NOW(), sp.createtime) >= 3 AND
            ((datediff(ti.updat_date,ti.track_update) IS null
            OR datediff(ti.updat_date,ti.track_update) > 3
            OR now() > ti.order_deliverDate))
            OR ti.track_state IN (4,5,6)))
        </if>
        <if test="warning == 1">
            AND ti.track_state != 3 AND ti.track_state != 7 AND datediff(NOW(), sp.createtime) >= 3
            AND (datediff(ti.updat_date,ti.track_update) IS null OR datediff(ti.updat_date,ti.track_update) > 3)
        </if>
        <if test="warning == 2">
            AND ti.track_state != 3 AND ti.track_state != 7
            AND now() > ti.order_deliverDate
        </if>
        <if test="warning == 4">
            AND ti.track_state = 4
        </if>
        <if test="warning == 5">
            AND ti.track_state = 5
        </if>
        <if test="warning == 6">
            AND ti.track_state = 6
        </if>
        <if test="startDate != ''">
            AND (of.orderpaytime >= #{startDate} OR of.orderpaytime IS NULL)
        </if>
        <if test="endDate != ''">
            AND (#{endDate} >= of.orderpaytime OR of.orderpaytime IS NULL)
        </if>
    </select>

    <select id="getRecordCountByTrackState" resultType="java.lang.Integer">
        SELECT
			COUNT(1)
		FROM
			(
				SELECT
					*
				FROM
					shipping_package
				WHERE
					sflag = 3
			) sp
		INNER JOIN orderinfo of ON sp.orderid = of.order_no
		LEFT JOIN cross_border_shop.tab_track_info ti 
			ON sp.transportcompany = ti.track_company AND sp.expressno = ti.track_no
        LEFT JOIN cross_border_shop.tab_track_forward tf
            ON sp.expressno = tf.track_no AND sp.transportcompany = tf.track_company
        LEFT JOIN admin_r_user ar ON of.user_id = ar.userid
        LEFT JOIN admuser au ON au.id = ar.adminid
        WHERE 1=1
        <if test="userid != null">
            AND ar.adminid = #{userid}
        </if>
        <if test="trackState != 0 and trackState != 7">
            AND ti.track_state = #{trackState} /*1-备货中；2-已发货；3-已签收；4-退回；5-异常(海关扣押等)；6-内部异常（抓取方式没有，单号问题等）; 7-手动标记正常*/
        </if>
        <if test="trackState == 7">
            AND ti.track_note IS NOT NULL AND ti.track_note != "" 
        </if>
        <if test="startDate != ''">
            AND (of.orderpaytime >= #{startDate} OR of.orderpaytime IS NULL)
        </if>
        <if test="endDate != ''">
            AND (#{endDate} >= of.orderpaytime OR of.orderpaytime IS NULL)
        </if>
    </select>
    
    <!-- void updatestate(TabTrackInfo tabTrackInfo); -->
    <update id="updatestate" parameterType="com.cbt.bean.TabTrackInfo">
    	UPDATE `cross_border_shop`.`tab_track_info`
		SET 
		 `track_state` = #{trackState},
		 `track_note` = #{trackNote},
		 `track_note_time` = NOW()
		<if test="trackState != 7">
            , up_state_time = '1970-01-01 00:00:00'
        </if>
		WHERE
			(`track_no` = #{trackNo});
    </update>
    
    <!-- TabTrackInfo queryStateByTrackNo(@Param("trackNo") String trackNo); -->
	<select id="queryStateByTrackNo" resultType="com.cbt.bean.TabTrackInfo">
        SELECT track_no trackNo, track_state trackState, track_note trackNote, track_note_time trackNoteTime,up_state_time upStateTime
        FROM cross_border_shop.tab_track_info 
        WHERE track_no = #{trackNo} 
        LIMIT 1
    </select>

</mapper>