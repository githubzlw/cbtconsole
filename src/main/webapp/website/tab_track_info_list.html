<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="utf-8"><!--  2018/07/17 12:29 -->
        <!--
    	文件兼容性声明，表示使用最新的ie渲染模式  
    -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!--
    	视口：用于设置移动端显示的效果的。就是移动端显示内容的区域的大小。
    		width=device-width：视口宽度等于设备宽度。
    		initial-scale=1   ：初始化缩放比，1:1
    -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
        <title>订单物流查询</title>

        <!-- 这是bootStrap所需要的css文件 -->
        <link href="/cbtconsole/css/bootstrap.min2.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!-- 
   		条件注释,专门为ie浏览器设计的。
   -->
        <!--[if lt IE 9]>
	      <script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	      <script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
	    <![endif]-->
        <!-- 这是bootstrap所必要的jquery文件。 -->
        <script src="/cbtconsole/js/jquery-2.1.0.min.js"></script>
        <!-- 这是bootstrap的js文件 -->
        <script src="/cbtconsole/js/bootstrap/bootstrap.min2.js"></script>
        <!-- 日期控件 -->
        <link href="/cbtconsole/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
        <script src="/cbtconsole/js/bootstrap/moment-with-locales.js"></script>
        <script src="/cbtconsole/js/bootstrap/bootstrap-datetimepicker.min.js"></script>
        <script src="/cbtconsole/js/bootstrap/bootstrap-datetimepicker.zh-CN.js"></script>
        <!--页面加载进度条-->
        <!--<script src="/cbtconsole/js/jgxLoader.js"></script>-->
        <!--easyui-->
        <script type="text/javascript" src="/cbtconsole/jquery-easyui-1.5.2/jquery.easyui.min.js"></script>
        <script type="text/javascript" src="/cbtconsole/jquery-easyui-1.5.2/locale/easyui-lang-zh_CN.js"></script>
        <script type="text/javascript" src="/cbtconsole/js/My97DatePicker/WdatePicker.js"></script>
        <link rel="stylesheet" type="text/css" href="/cbtconsole/jquery-easyui-1.5.2/themes/default/easyui.css">
        <link rel="stylesheet" type="text/css" href="/cbtconsole/jquery-easyui-1.5.2/themes/icon.css">
        <style type="text/css">
            .panel-title {
                text-align: center;
                height: 30px;
                font-size: 24px;
            }
            
            .but_color {
                background: #44a823;
                width: 80px;
                height: 35px;
                border: 1px #aaa solid;
                color: #fff;
            }
            
            input,
            textarea,
            select,
            button {
                font-size: 16px;
                height: 28px;
            }
            
            .datagrid-cell,
            .datagrid-cell-group,
            .datagrid-header-rownumber,
            .datagrid-cell-rownumber {
                font-size: 16px;
            }
            
            .datagrid-header .datagrid-cell span,
            .panel-body {
                font-size: 16px;
            }
            
            .datagrid-cell,
            .datagrid-cell-group,
            .datagrid-header-rownumber,
            .datagrid-cell-rownumber {
                height: 28px;
                line-height: 28px;
                padding: 3px 5px;
            }
            
            #waring_id span a {
				color: red;
				font-weight: bolder;
			}

            .but, .but:hover, .but:active, .but:visited, .but:link {
                background-color: rgba(22, 155, 213, 1);
                border-radius: 5px;
                width: 90px;
                height: 28px;
                color: white;
                display: block;
                cursor: pointer;
                text-decoration: none;
                margin: auto;
            }

            #top_toolbar table td {
                line-height: 30px;
            }

        </style>

    </head>

    <body>
        <!-- 模态框（Modal） 弹窗物流信息-->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width: 76%;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">保存在本地的物流信息</h4>
                    </div>
                    <div class="modal-body" style="float: left;font-size: 13px;width: 100%;">
                    	<h3>运单信息</h3>
                    	<table id="tab_track_info" class="table table-striped table-hover">
                            <!--<tr>
                                <th width="25%">单号来源</th>
                                <th width="25%">运单号</th>
                                <th width="25%">运输公司</th>
                                <th width="25%">物流获取源</th>
                            </tr>
                    		<tr>
                                <td>原单号</td>
                                <td>123465</td>
                                <td>ems</td>
                                <td>暂无</td>
                    		</tr>
                            <tr>
                                <td>转单号</td>
                                <td>123465</td>
                                <td>ems</td>
                                <td>暂无</td>
                            </tr>-->
                    	</table>
                    	<h3>物流抓取操作</h3>
                        <a id="sync_track1" target="_blank">增量抓取(抓取并保存未保存物流)</a>&nbsp;&nbsp;&nbsp;&nbsp;
                        <a id="sync_track2" target="_blank">完整抓取(清空已抓取的重新抓取一份)</a>
                        <br /><br />
                    	<h3>合并的物流信息</h3>
                        <table class="table table-striped table-hover" style="float: left;font-size: 13px;" id="tab_track_details_list">
                            <!--<tr><th width="22%">时间</th><th width="78%">状态</th></tr>
							<tr><td>2018-04-13 00:00</td><td id="reason1">在上海虹桥</td></tr>
							<tr><td>2018-04-13 00:02</td><td id="reason1">在上海虹桥2</td></tr>-->
                        </table>

                    </div>
                    <div class="modal-footer">
                        <!--<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>-->
                        <!--<button type="button" class="btn btn-primary">提交更改</button>-->
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal -->
        </div>


		<!-- 模态框（Modal） 修改状态 -->
        <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width: 680px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title">运单状态修改</h4>
                    </div>
                    <div class="modal-body">
                        <div>
                            <span>&nbsp;&nbsp;运单号:&nbsp;&nbsp;</span><span id="modal_trackNo2"></span><br />
                            <span style="float: left;line-height: 30px;">&nbsp;&nbsp;状态:&nbsp;&nbsp;</span>
                            <input type="radio" name="trackState" value="2" checked="checked" style="float: left;height: 20px;" />
                            <span style="float: left;line-height: 30px;">&nbsp;1.出运中(或者原本是异常)&nbsp;&nbsp;</span>
                            <input type="radio" name="trackState" value="7" style="float: left;height: 20px;" />
                            <span style="float: left;line-height: 30px;">&nbsp;2.手动标记正常&nbsp;&nbsp;</span>
                            <input type="radio" name="trackState" value="3" style="float: left;height: 20px;" />
                            <span style="float: left;line-height: 30px;">&nbsp;3.手动标记已签收(或者已经是已签收)</span><br />
                            <div style="clear:both"></div>
                            <span>&nbsp;&nbsp;标记备注:</span>
                            <span>&nbsp;&nbsp;(最后标记时间:</span>
                            <span id="track_note_time"></span><span>)</span><br />
                            <textarea rows="60" cols="60" id="track_note" style="height: 150px;width: 566px;"></textarea><br />
                            <input type="button" value="提交" id="myModal2_sub"><span id="myModal2_sub_message" style="color:red;"></span>
                            <span>
                                <br/>状态说明:
                                <br/>1.修改到“出运中”后运单正常抓取,如果运单有异常,会出现在“运单预警”中;
                                <br/>2.修改到“手动标记正常”后,运单不会出现在“运单预警”中。如果运单抓取中判断为签收状态,则状态会更新到“已签收”;“手动标记正常”标记7天有效,7天后如果运单异常则会继续出现在“运单预警”中;
                                <br/>3.修改到“手动标记已签收”后,后续运单不会再抓取,线上此运单是签收状态(签收状态数据同步到线上需要10分钟左右)。
                            </span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <!-- <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button> -->
                    </div>
                </div>
            </div>
        </div>
        
        <script type="text/javascript">
            function formatNum(val) {
                return val < 10 ? "0" + val : val
            }


            //获取url中的参数
            function getUrlParam(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
                var r = window.location.search.substr(1).match(reg); //匹配目标参数
                if(r != null) return unescape(r[2]);
                return null; //返回参数值
            }

            
            $(function() {
                $('#main-datagrid').datagrid({
                    //title: '复购率退款数商品查询',
                    width: "100%",
                    fit: true, //自动补全 
                    pageSize: 20, //默认选择的分页是每页20行数据
                    pageList: [10, 20, 30, 50, 100], //可以选择的分页集合
                    nowrap: true, //设置为true，当数据长度超出列宽时将会自动截取
                    striped: true, //设置为true将交替显示行背景。
                    collapsible: true, //显示可折叠按钮
                    toolbar: "#top_toolbar", //在添加 增添、删除、修改操作的按钮要用到这个
                    //				url: "/cbtconsole/tabtrackinfo/list.do",
                    loadMsg: '数据装载中......',
                    singleSelect: true, //为true时只能选择单行
                    fitColumns: true, //允许表格自动缩放，以适应父容器
                    pagination: true, //分页
                    rownumbers: true,
                    style: {
                        padding: '8 8 10 8'
                    },
                    onLoadError: function() {
                        //$.message.alert("提示信息", "获取数据信息失败","info");
                        return;
                    }
                });


                $("#order_user_id, #order_no, #order_track_no").focus(function() {
                    var cur_text = $(this).val();
                    if(cur_text == "请输入用户ID或者用户邮箱"
                        || cur_text == "请输入订单编号"
                        || cur_text == "请输入运单号或转单号"
                        ) {
                        $(this).val('');
                        $(this).css('color', '#222');
                    }
                });
                $("#order_user_id, #order_no, #order_track_no").blur(function() {
                    var cur_text = $(this).val();
                    if (cur_text == undefined || cur_text == '') {
                        var cur_id = $(this).attr('id');
                        if (cur_id == 'order_user_id') {
                            $(this).val('请输入用户ID或者用户邮箱');
                        } else if (cur_id == 'order_no') {
                            $(this).val('请输入订单编号');
                        } else if (cur_id == 'order_track_no') {
                            $(this).val('请输入运单号或转单号');
                        }
                        $(this).css('color', '#C4C4C4');
                    }
                });


                //操作订单运单状态
                $("#myModal2_sub").click(function() {
                	var trackState = $('input[type=radio][name=trackState]:checked').val();
                	var trackNote = $('#track_note').val();
                	var trackNo = $('#modal_trackNo2').text();
                	$.ajax({
               		   type: "POST",
               		   url: "/cbtconsole/tabtrackinfo/updatestate.do?trackNo=" + trackNo + "&trackNote=" + trackNote + "&trackState=" + trackState,
               		   dataType:"text",
               		   success: function(msg){
               			   if("success" == msg){
                        	   $('#myModal2_sub_message').text("修改成功!");
               			   }
               		   }
               		});
                });


                //设置日期时间控件
                function Datetime(dateId) {
                    $(dateId).datetimepicker({
                        language: 'zh-CN', //显示中文
                        format: 'yyyy-mm-dd', //显示格式
                        minView: "month", //设置只显示到月份
                        initialDate: new Date(),
                        autoclose: true, //选中自动关闭
                        todayBtn: true, //显示今日按钮
                        locale: moment.locale('zh-cn')
                    });
                }
                Datetime('#datetimepicker1');
                Datetime('#datetimepicker2');
                Datetime('#paytimepicker1');
                Datetime('#paytimepicker2');

                function iniDatetime() {
                    //时间选择框日期初始化
                    var today = new Date();
                    var nowdate = (today.getFullYear()) + "-" + (today.getMonth() + 1) + "-" + today.getDate();
                    //对日期格式进行处理
                    var date = new Date(nowdate);
                    var mon = date.getMonth() + 1;
                    var day = date.getDate();
                    var mydate = date.getFullYear() + "-" + (mon < 10 ? "0" + mon : mon) + "-" + (day < 10 ? "0" + day : day);
                    document.getElementById("nowdate2").value = '';
                    document.getElementById("paydate2").value = mydate;
                    today = new Date();
                    today.setDate(today.getDate() - 90); //日期减90天
                    nowdate = (today.getFullYear()) + "-" + (today.getMonth() + 1) + "-" + today.getDate();
                    date = new Date(nowdate);
                    mon = date.getMonth() + 1;
                    day = date.getDate();
                    mydate = date.getFullYear() + "-" + (mon < 10 ? "0" + mon : mon) + "-" + (day < 10 ? "0" + day : day);
                    document.getElementById("nowdate1").value = '';
                    document.getElementById("paydate1").value = mydate;
                }
                iniDatetime();


                /*查询条件重置按钮*/
                $("#date_range_reset").click(function() {
                    $("#order_user_id").val("请输入用户ID或者用户邮箱");
                    $("#order_user_id").css("color","#C4C4C4");
                    $("#order_no").val("请输入订单编号");
                    $("#order_no").css("color","#C4C4C4");
                    $("#order_track_no").val("请输入运单号或转单号");
                    $("#order_track_no").css("color","#C4C4C4");

                    iniDatetime();

                    $("#trackState").val(0);
                    $("#warning").val(-1);
                    $("#adminSelect").val(0);
                });


                /*条件查询*/
                $("#date_range_search").click(function() {
                    // 页数
                    var pageSize = $("#main-datagrid").datagrid("options").pageSize;
                    var pageNumber = 1;
                    // 第一行
                    var orderUserid = $("#order_user_id").val() == '请输入用户ID或者用户邮箱'?'':$("#order_user_id").val();
                    var orderNo = $("#order_no").val() == '请输入订单编号'?'':$("#order_no").val();
                    var orderTrackNo = $("#order_track_no").val() == '请输入运单号或转单号'?'':$("#order_track_no").val();
                    // 第二行 支付起止时间
                    var payStartDate = $("#paydate1").val();
                    var payEndDate = $("#paydate2").val();
                    if((new Date(payStartDate)) > (new Date(payEndDate))) {
                        $("#errMsg").text("开始时间应该不晚于结束时间。");
                        setTimeout(function() {
                            $("#errMsg").text("");
                        }, 1500);
                        return;
                    } else {
                        $("#errMsg").text("");
                    }
                    // 出货起止时间
                    var startDate = $("#nowdate1").val();
                    var endDate = $("#nowdate2").val();
                    if((new Date(startDate)) > (new Date(endDate))) {
                        $("#errMsg").text("开始时间应该不晚于结束时间。");
                        setTimeout(function() {
                            $("#errMsg").text("");
                        }, 1500);
                        return;
                    } else {
                        $("#errMsg").text("");
                    }
                    var userid = $("#adminSelect").val();
                    // 第三行
                    var trackState = $("#trackState").val();
                    var warning = $("#warning").val();

                    var param = {
                        rows: pageSize,
                        page: pageNumber,
                        orderUserid: orderUserid,
                        orderNo: orderNo,
                        orderTrackNo: orderTrackNo,
                        payStartDate: payStartDate,
                        payEndDate: payEndDate,
                        startDate: startDate,
                        endDate: endDate,
                        userid: userid,
                        trackState: trackState,
                        warning: warning
                    };

                    if(Window.EXPORTEXCELFLAG){
                        //查询
                        $("#main-datagrid").datagrid("options").url = "/cbtconsole/tabtrackinfo/list.do";
                        $('#main-datagrid').datagrid("load", param);
                    } else {
                        //导出 查询并数据并保存到csv文件
                        param['export'] = 1;
                        $.ajax({
                            type: "GET",
                            url: "/cbtconsole/tabtrackinfo/list.do",
                            data: param,
                            dataType:"json",
                            success: function(msg){
                                Window.EXPORTEXCELFLAG = true;
                                $("#exportExcel").text("导出");
                                if (msg.success == true){
                                    var str = encodeURIComponent(msg.message);
                                    var uri = 'data:text/csv;charset=utf-8,\ufeff' + str;
                                    var downloadLink = document.createElement("a");
                                    downloadLink.href = uri;
                                    downloadLink.weight="100";
                                    downloadLink.download = "export_track_list_" + startDate + "_" + endDate + ".csv";
                                    document.body.appendChild(downloadLink);
                                    downloadLink.click();
                                    document.body.removeChild(downloadLink);
                                } else {
                                    alert(msg.message);
                                }
                            }
                        });
                    }
                });

            });

            /*导出*/
            Window.EXPORTEXCELFLAG = true; //导出数据按钮是否可点击：false-正在导出；true-可导出；
            function exportExcel() {
                $("#exportExcel").text("导出中...")
                if(!Window.EXPORTEXCELFLAG){
                    alert("正在导出, 请等待...");
                    return;
                }
                Window.EXPORTEXCELFLAG = false;
                $("#date_range_search").click();
            }

            /* 单条运单操作 */
            function formatterOperation(value, row, index) {
            	if(row.trackNo != null) {
	            	return '<a class="but" href="#" onclick="alert_modal2(\'' + row.trackNo + '\')">修改状态</a>';
           		}
           		return;
            } 
            /*时间格式化*/
            function formatterData(value, row, index) {
                if(value != null) {
                    var date = new Date(value);
                    return date.getFullYear() + '-' + formatNum(date.getMonth() + 1) + '-' + formatNum(date.getDate());
                } else {
                    return "";
                }
            } 
            /*时间格式化2*/
            function formatterData2(value, row, index) {
                if(value != null) {
                    var date = new Date(value);
                    return date.getFullYear() + '-' + formatNum(date.getMonth() + 1) + '-' + formatNum(date.getDate()) + ' ' + formatNum(date.getHours()) + ':' + formatNum(date.getMinutes());
                } else {
                    return "";
                }
            }
            /* 链接到订单 formatterOrderNo */
            function formatterOrderNo(value, row, index) {
                if(row.orderNo != null) {
	            	return '<a href="/cbtconsole/orderDetails/queryByOrderNo.do?orderNo=' + row.orderNo + '" target=black>' + row.orderNo + '</a>'
           		}
           		return;
            }
            /*格式化数据获取来源 formatterSourceType*/
//          function formatterSourceType(value, row, index) {
////          	if(row.sourceType != null) {
////                  var trackNoStr = "'" + row.trackNo + "'";
////                  return '<a onclick="alert_modal(' + trackNoStr + ');">本地</a>'
////              }
//          	
//              if(row.sourceType != null) {
//              	var trackNoStr = "'" + row.trackNo + "'";
//                  return '<a href="' + value + '" target=black>' + 原信息 + '</a>' + '<a onclick="alert_modal(' + trackNoStr + ');">本地</a>';
//              }
//              return;
//          }
            /*运单状态格式化 formatterTrackState 1-备货中；2-已发货；3-已签收；4-退回；5-异常(海关扣押等)；6-内部异常（运单异常，相关快递抓取方式未实现等）*/
            function formatterTrackState(value, row, index) {
                if(row.trackState != undefined && row.trackState != '') {
                    switch(row.trackState) {
                        case 3:
                            return '已签收';
                        case 4:
                            return '退回';
                        case 5:
                            return '异常';
                        case 6:
                            return '内部异常';
                        case 7:
                            return '手动标记正常';
                        default:
                            return '已发货';
                    }
                }
                if (row.trackNo != undefined && row.trackNo != '') {
                    return '已发货';
                }
                return '';
            }
            /*运单预警 formatterWarning*/
           function formatterWarning(value, row, index) {
           		//set集合保存结果
           		var resSet = new Set();
           		//查询常见问题
                if(row.trackState != null) {
                	if (row.trackState == 4) {
                		resSet.add('退回');
                	}
                	if (row.trackState == 5) {
                		resSet.add('异常');
                	}
                	if (row.trackState == 6) {
                		resSet.add('内部异常');
                	}
                	if(row.trackState != 3 && row.trackState != 7) {
                		//交期超时查询
		                if(row.orderDeliverDate == null){
		                	resSet.add('交期为空');
		                } else if (new Date() > new Date(row.orderDeliverDate)){
		                	resSet.add('交期超时');
		                }
		                //物流问题
		                if(row.trackUpdate == undefined || row.updatDate == undefined){
		                	var senttime = new Date(row.senttime);
		                	var defDays = parseInt(new Date() - senttime) / 1000 / 3600 / 24;
		                	if(defDays > 3){
		                		resSet.add('无物流');
		                	}
		                } else {
		                	var trackUpdate = new Date(row.trackUpdate);//最后一次运单变更时间
		                	var updatDate = new Date(row.updatDate); //最后一次抓取时间
		                	var defDays = parseInt(updatDate - trackUpdate) / 1000 / 3600 / 24;
		                	if (defDays > 3) {
		                		resSet.add('物流问题');
		                	}
		                }
                	}
                }
                //数据格式转换  示例：退回,异常,内部异常
                var resArr = new Array(resSet.size);
                var i = 0;
                resSet.forEach(function(item, sameItem, s) {
                	resArr[i] = item;
                	i++;
				});
				return resArr.join(",");
            }
            /*运单状态格式化 formatterGrabState 1-备货中；2-已发货；3-已签收；4-退回；5-异常(海关扣押等)*/
            function formatterGrabState(value, row, index) {
                if(row.grabState == 1) {
                    return "不需要抓取";
                } else {
                    return "需要抓取";
                }
            }

            function alert_modal(trackNo) {
                var tab_track_details_list = $("#tab_track_details_list");
                var tab_track_info = $("#tab_track_info");
                tab_track_details_list.empty();
                tab_track_info.empty();

                //查询存储在本地的物流信息
                $.ajax({
                    type: "GET",
                    url: "/cbtconsole/tabtrackinfo/querybytrackno.do?trackNo=" + trackNo,
                    dataType: "json",
                    success: function(msg) {
                        tab_track_info.append('<tr><th width="10%">单号来源</th><th width="20%">运单号</th><th width="20%">运输公司</th><th width="50%">物流获取源</th></tr>');
                        // 原单号
                        $('<tr>').append($('<th>', {
                            text: '原单号'
                        })).append($('<td>', {
                            text: trackNo
                        })).append($('<td>', {
                            text: msg.trackCompany
                        })).append($('<td>', {
                            html: msg.sourceType == undefined ? '暂无':'<a href="' + msg.sourceType + '" target=black>' + msg.trackNo + '</a>'
                        })).appendTo(tab_track_info);

                        // 转单
                        if (msg.forwardList != undefined) {
                            $(msg.forwardList).each(function (index, item) {
                                $('<tr>').append($('<th>', {
                                    text: '转单号'
                                })).append($('<td>', {
                                    text: item.trackNoForward
                                })).append($('<td>', {
                                    text: item.trackCompanyForward
                                })).append($('<td>', {
                                    html: item.sourceType == undefined ? '暂无':'<a href="' + item.sourceType + '" target=black>' + item.trackNoForward + '</a>'
                                })).appendTo(tab_track_info);
                            });
                        }

                        tab_track_details_list.append($('<tr><th width="11%">时间</th><th width="40%">线上显示物流</th><th width="40%">抓取的源数据</th><th width="10%">获取来源</th></tr>')); //添加标题
                        $(msg.tabTrackDetailsList).each(function(index, item) {
                            var temDate = new Date(item.actionDate);
                            var temDateStr = temDate.getFullYear() + '-' + formatNum(temDate.getMonth() + 1) + '-' + formatNum(temDate.getDate()) + ' ' + formatNum(temDate.getHours()) + ':' + formatNum(temDate.getMinutes());
							var temFlag = "";
							if(item.flag == 2){
								temFlag = "转单运单";
							} else if(item.flag == 3) {
								temFlag = "手动添加";
							} else if(item.flag == 4) {
								temFlag = "历史运单";
							} else {
								temFlag = "原运单";
							}
                            var temHtml = "<tr><td>" +
                                temDateStr +
                                "</td><td>" +
                                item.actionInfo +
                                "</td><td>" +
                                (item.actionInfoCn == undefined?"":item.actionInfoCn) +
                                "</td><td>" +
                                temFlag +
                                "</td></tr>";
                            $(temHtml).appendTo(tab_track_details_list);
                        });
                        //显示模态框
                        $('#myModal').modal('show');
                        //绑定物流抓取事件
                        $('#sync_track1').click(function(){
                        	$('#sync_track1').attr("href","http://192.168.1.48:18081/rest/patch/syntrackone.do?flag=0&trackNo=" 
                        			+ trackNo + "&trackCom=" + encodeURI($("#modal_trackCompany").text()));
                    	});
                        $('#sync_track2').click(function(){
                        	$('#sync_track2').attr("href","http://192.168.1.48:18081/rest/patch/syntrackone.do?flag=1&trackNo=" 
                        			+ trackNo + "&trackCom=" + encodeURI($("#modal_trackCompany").text()));
                    	});
                    }
                });
            }
            function alert_modal2(trackNo) {
            	// 初始值
            	$('#modal_trackNo2').text(trackNo);
                $('#myModal2_sub_message').text("");
                //初始化该订单之前修改记录
            	$.ajax({
           		   type: "GET",
           		   url: "/cbtconsole/tabtrackinfo/querystatebytrackno.do?trackNo=" + trackNo,
           		   dataType:"json",
           		   success: function(msg){
           			   if(7 == msg.trackState){
           				  $('input[type=radio][name=trackState]').get(1).checked = "checked";
           			   } else if(3 == msg.trackState){
             			  $('input[type=radio][name=trackState]').get(2).checked = "checked";
           			   } else {
                           $('input[type=radio][name=trackState]').get(0).checked = "checked";
                       }
					   $('#track_note').val(msg.trackNote);
					   $('#track_note_time').text(formatterData2(msg.trackNoteTime, null, null));
                       $('#myModal2').modal('show');
           		   }
           		});
            }
            /*格式化本地物流数据查看 formatterSourceType*/
            function formatterSourceType(value, row, index) {
//                if(row.sourceType != null) {
                    var trackNoStr = "'" + row.trackNo + "'";
                    return '<a onclick="alert_modal(' + trackNoStr + ');">本地</a><span>&nbsp;&nbsp;</span><a href="' + row.sourceType + '" target=black>原物流 </a>';
//                }
//                return;
            }
            function formatterTrackNo(value, row, index) {
                    return '<a href="#" onclick="alert_modal(\'' + row.trackNo + '\');">' + row.trackNo + '</a>';
            }
            function formatterId(value, row, index) {
                    return '<a target="_blank" href="/cbtconsole/userinfo/getUserInfo.do?userId=' + row.id + '">' + row.id + '</a>';
            }
        </script>

        <div id="top_toolbar" style="padding: 5px; height: auto">
            <h3>订单物流查询</h3>
            <div id="waring_id" style="position: absolute;top: 28px;right: 100px;" ></div>
            <table class="table" style="width: 94%; margin-bottom: 0px;">
                <tr>
                    <td>
                        用户:
                    </td>
                    <td>
                        <input type="text" name="" id="order_user_id" value="请输入用户ID或者用户邮箱" style="height: 28px;width: 330px;color: #C4C4C4;" />
                    </td>
                    <td>
                        订单编号:
                    </td>
                    <td>
                        <input type="text" name="" id="order_no" value="请输入订单编号" style="height: 28px;width: 330px;color: #C4C4C4;" />
                    </td>
                    <td>
                        运单号:
                    </td>
                    <td>
                        <input type="text" name="" id="order_track_no" value="请输入运单号或转单号" style="height: 28px;width: 260px;color: #C4C4C4;" />
                    </td>
                </tr>
                <tr>
                    <td>
                        支付时间:
                    </td>
                    <td>
                        <a class='input-group date' id='paytimepicker1' style="float: left;">
                            <input type='text' class="form-control" id='paydate1' style="width: 100px; height: 30px;"/>
                            <span class="input-group-addon" style="float: left; width: 50px; height: 30px;">
		                        <span class="glyphicon glyphicon-calendar"></span>
			                </span>
                        </a>
                        <span style="float: left; margin: 0 6px">到</span>
                        <a class='input-group date' id='paytimepicker2' style="float: left;">
                            <input type='text' class="form-control" id='paydate2' style="width: 100px; height: 30px;" />
                            <span class="input-group-addon" style="float: left; width: 50px; height: 30px;">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </a>
                    </td>
                    <td>
                        出货时间:
                    </td>
                    <td>
                        <a class='input-group date' id='datetimepicker1' style="float: left;">
                            <input type='text' class="form-control" id='nowdate1' style="width: 100px; height: 30px;"/>
                            <span class="input-group-addon" style="float: left; width: 50px; height: 30px;">
		                        <span class="glyphicon glyphicon-calendar"></span>
			                </span>
                        </a>
                        <span style="float: left; margin: 0 6px">到</span>
                        <a class='input-group date' id='datetimepicker2' style="float: left;">
                            <input type='text' class="form-control" id='nowdate2' style="width: 100px; height: 30px;" />
                            <span class="input-group-addon" style="float: left; width: 50px; height: 30px;">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </a>
                    </td>
                    <td>
                        负责人:
                    </td>
                    <td>
                        <select class="form-control" id="adminSelect" style="height: 30px;width: 260px;font-size: 14px;padding-top: 4px;padding-left: 4px;">
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>
                        运单状态:
                    </td>
                    <td>
                        <select class="form-control" id="trackState" style="height: 30px;width: 330px;font-size: 14px;padding-top: 4px;padding-left: 4px;">
                            <option value="0">0-不进行筛选</option>
                            <!--<option value="1">1-备货中</option>-->
                            <option value="2">2-已发货</option>
                            <option value="3">3-已签收</option>
                            <option value="4">4-退回</option>
                            <option value="5">5-异常(海关扣押等)</option>
                            <option value="6">6-内部异常(运单异常等)</option>
                            <option value="7">7-手动标记为正常</option>
                        </select>
                    </td>
                    <td>
                        运单预警:
                    </td>
                    <td>
                        <select class="form-control" id="warning" style="height: 30px;width: 330px;font-size: 14px;padding-top: 4px;padding-left: 4px;">
                            <option value="-1">0-不进行筛选</option>
                            <option value="0">全部预警运单</option>
                            <option value="1">1-物流问题 或者 无物流 (未签收 并且 最后一次运单变更时间在3天前)</option>
                            <option value="2">2-交期超时 (未签收 并且 过了订单的最晚交期)</option>
                            <option value="4">4-退回</option>
                            <option value="5">5-异常 (海关扣押等)</option>
                            <option value="6">6-内部异常 (运单异常等)</option>
                        </select>
                    </td>
                    <td colspan="2">
                        <button type="button" id="date_range_search" class="btn btn-default" style="height: 30px;width: 98px;text-align: center;" >查询</button>
                        <button type="button" id="date_range_reset" class="btn btn-default" style="height: 30px;text-align: left;">重置</button>
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <button type="button" onclick="exportExcel()" id="exportExcel" class="btn btn-default" style="height: 30px;text-align: left;">导出</button>
                        &nbsp;&nbsp;<span id="errMsg" style="color: royalblue;"></span>
                    </td>
                </tr>
            </table>
        </div>

        <table id="main-datagrid" firstLoad="false" style="width: 100%; height: 100%" class="easyui-datagrid">
            <thead>
                <tr>
                    <th data-options="field:'id',width:'120px',align:'center',formatter:formatterId">用户ID</th>
                    <!--<th data-options="field:'email',width:'120px',align:'center'">用户邮箱</th>-->
                    <th data-options="field:'orderNo',width:'150px',align:'center',formatter:formatterOrderNo">主单号</th>
                    <!--<th data-options="field:'orderList',width:'150px',align:'center'">合并订单列表</th>-->
                    <th data-options="field:'trackNo',width:'150px',align:'center',formatter:formatterTrackNo">运单号</th>
                    <th data-options="field:'admName',width:'150px',align:'center'">负责人</th>
                    <!--<th data-options="field:'trackCompany',width:'120px',align:'center'">物流公司</th>-->
                    <!--<th data-options="field:'forwardNo',width:'150px',align:'center'">转单号</th>-->
                    <!--<th data-options="field:'forwardCompany',width:'150px',align:'center'">转单物流公司</th>-->
                    <th data-options="field:'trackState',width:'100px',align:'center',formatter:formatterTrackState">运单状态</th>
                    <!--<th data-options="field:'info',width:'150px',align:'center'">最新物流</th>-->
                    <th data-options="field:'b',width:'260px',align:'center',formatter:formatterWarning">运单预警</th>
                    <!--<th data-options="field:'packageNo',width:'150px',align:'center'">包裹号</th>-->
                    <!--<th data-options="field:'trackAddress',width:'150px',align:'center'">寄件地址</th>-->
                    <th data-options="field:'orderPaytime',width:'150px',align:'center',formatter:formatterData">支付时间</th>
                    <th data-options="field:'senttime',width:'150px',align:'center',formatter:formatterData">出货时间</th>
                    <th data-options="field:'orderDeliverDate',width:'150px',align:'center',formatter:formatterData">最晚交期</th>
                    <!--<th data-options="field:'trackUser',width:'150px',align:'center'">登陆人员</th>-->
                    <!--<th data-options="field:'grabState',width:'100px',align:'center',formatter:formatterGrabState">抓取状态</th>-->
                    <!--<th data-options="field:'addTime',width:'160px',align:'center',formatter:formatterData">录入时间</th>-->
                    <!--<th data-options="field:'trackUpdate',width:'160px',align:'center',formatter:formatterData">最后一次运单变更时间</th>-->
                    <!--<th data-options="field:'updatDate',width:'160px',align:'center',formatter:formatterData">最后一次抓取时间</th>-->
                    <!--<th data-options="field:'deliveredTime',width:'160px',align:'center',formatter:formatterData">运单完成时间</th>-->
                    <th data-options="field:'d',width:'160px',align:'center',formatter:formatterOperation">操作</th>
                    <!--<th data-options="field:'sourceType',width:'150px',align:'center',formatter:formatterSourceType">物流信息</th>-->
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

    </body>
    
    <script type="text/javascript">
	    $(function(){
            //负责人拉取
            $.ajax({
                type : 'POST',
                async : false,
                url : '/cbtconsole/admuser/queryAllAdmuser',
                success : function(data){
                    if(data.ok){
                        var results = data.data;
                        var options = '<option value="0" selected="selected">全部</option>';
                        for (var i = 0; i < results.length; i++) {
                            options += '<option value="'+results[i].id+'">'+results[i].admname+'</option>';
                        }
                        $("#adminSelect").empty();
                        $("#adminSelect").append(options);
                    } else{
                        alert("获取下拉框数据失败，请重新刷新页面");
                    }
                }
            });
	    	$.ajax({
    		   type: "GET",
    		   url: "/cbtconsole/tabtrackinfo/querywaringnum.do?payStartDate=" + $("#paydate1").val() + "&payEndDate=" + $("#paydate2").val(),
    		   dataType:"json",
    		   success: function(msg){
    		     var waringtext = "最近<strong>90</strong>天预警信息 (0-总预警条数:<span><a name='0' href='javascript:;'>" + msg.waring0
    		    		 + "</a></span>条; 1-物流问题:<span><a name='1' href='javascript:;'>" + msg.waring1
    		    		 + "</a></span>条; 2-交期超时:<span><a name='2' href='javascript:;'>" + msg.waring2
    		    		 + "</a></span>条; 4-退回:<span><a name='4' href='javascript:;'>" + msg.waring4
    		    		 + "</a></span>条; 5-异常:<span><a name='5' href='javascript:;'>" + msg.waring5
    		    		 + "</a></span>条; 6-内部异常:<span><a name='6' href='javascript:;'>" + msg.waring6
    		    		 + "</a></span>条;)"
    		     $("#waring_id").html(waringtext);
    		     // 点击事件
                 $('#waring_id a').click(function () {
                     $("#date_range_reset").click();
                     $("#warning").val($(this).attr('name'));
                     $("#date_range_search").click();
                 });
    		   }
    		});
	    	// 页面打开默认加载
            var warning = getUrlParam("warning");
            if (warning != undefined) {
                $("#warning").val(warning);
            }
            $("#date_range_search").click();
	    });
    </script>

</html>